<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="Author" content="Bob & Kelly Crispen">
   <meta name="GENERATOR" content="Mozilla/4.75 [en] (Win98; U) [Netscape]">
   <title>Adding a Search Engine to your Hypermail Archives</title>
   <style type="text/css">
      .pod PRE     {
        background: #eeeeee;
        border: 1px solid #888888;
        color: black;
        padding-top: 1em;
        white-space: pre;
      }
   </style>
</head>
<body>

<center>
<h1>Adding a Search Engine<br>to your Hypermail Archives</h1></center>

<div class=pod>
<p>One of the most popular feature requests for hypermail is adding
the ability to search your archives.  Since everyone has his or her
own favorite search engine, and since it's hard to imagine a search engine
that may not turn out to be unusable
for some archives, we have not built a search engine into hypermail, and
probably won't.

<p>But hypermail's page
customizations make it easy to integrate your own search engine into your
hypermail archives.

<p>For our example, we're going to put a form box on the top and bottom of
every index page, and we'll use the <a href="http://swish-e.org/">swish-e</a>
search engine, using a <a href="http://www.php.net/">PHP</a> script as a
glue layer between the web and the search engine.
There ought to be enough information here to get you
started regardless of what search engine and scripting language you choose
for your site.
<p>Let's begin by modifying the header and footer hypermail puts on each
index file.
<p>(1) Create a file called indexheader.hyp containing the following:
<pre>
    &lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
      "http://www.w3.org/TR/html4/strict.dtd">
    &lt;html lang="en">
    &lt;head>
    &lt;meta name="generator" content="%p %v, see %h">
    &lt;title>%l: %s&lt;/title>
    &lt;meta name="Subject" content="%s">
    &lt;meta name="Date" content="(nil)">
    &lt;link rev="made" href="mailto:%m">
    &lt;style type="text/css">
    body {color: black; background: #ffffff}
    h1.center {text-align: center}
    div.center {text-align: center}
    .quotelev1 {color : #990099}
    .quotelev2 {color : #ff7700}
    .quotelev3 {color : #007799}
    .quotelev4 {color : #95c500}
    .headers {background : #e0e0d0}
    .links {background : #f8f8e0}
    &lt;/style>
    &lt;/head>
    &lt;body>
    &lt;h1 class="center">%l&lt;br>%s&lt;/h1>

    &lt;!-- Your custom code goes below this line -->

    &lt;div class="center">
    &lt;FORM ACTION="http://url/of/search.php" METHOD="POST"
        ENCTYPE="application/x-www-form-urlencoded">
    &lt;INPUT TYPE="HIDDEN" NAME="db" VALUE="name.of.index">
    &lt;p class="headers">
    &lt;INPUT TYPE="TEXT" NAME="str" SIZE="20">
    &lt;INPUT TYPE="SUBMIT" VALUE="Search">
    &lt;/p>
    &lt;/FORM>
    &lt;/div>

</pre><p>Notice the HTML comment about 2/3 of the way down.  Everything
above that line is standard, and ought to be very similar to the default
header.  The custom code (below the comment) adds the features you
want to add.  In this case, it's a form for a search.
<p>You will, of course, substitute your own URL for search.php for the form's ACTION
and the name of your own search index for "name.of.index".  See the bottom of this page for
an example of creating a search index file.
<p>(2) Create a file called indexfooter.hyp containing the following:
<pre>
    &lt;div class="center">
    &lt;FORM ACTION="/url/of/search.php" METHOD="POST"
        ENCTYPE="application/x-www-form-urlencoded">
    &lt;INPUT TYPE="HIDDEN" NAME="db" VALUE="name.of.index">
    &lt;p class="headers">
    &lt;INPUT TYPE="TEXT" NAME="str" SIZE="20">
    &lt;INPUT TYPE="SUBMIT" VALUE="Search">
    &lt;/p>
    &lt;/FORM>
    &lt;/div>

    &lt;!-- Your custom code goes above this line -->

    &lt;hr>
    &lt;p>&lt;small>&lt;em>
    This archive was generated by &lt;a href="%h">%p %v&lt;/a> : %g
    &lt;/em>&lt;/small>&lt;/p>
    &lt;/body>
    &lt;/html>

</pre><p>Since this is a footer file, the common code will be at the end, and
you'll put your custom code above the comment.
<p>(3) Modify the .hmrc file to point to your custom header and footer:
<pre>
    # ihtmlheaderfile = [ path to index header template file | NONE ]
    #
    # Set this to the path to the Index header template file containing
    # valid HTML statements and substitution cookies for runtime expansion.
    # This will be included at the top of every index page.
    
    ihtmlheaderfile = /path/to/indexheader.hyp
    
    # ihtmlfooterfile = [ path to index footer template file | NONE ]
    #
    # Set this to the path to the Index footer template file containing
    # valid HTML statements and substitution cookies for runtime expansion.
    # This will be included at the bottom of every index page.
    
    ihtmlfooterfile = /path/to/indexfooter.hyp

</pre><p>You'll call hypermail using this .hmrc file to create your archive
or add a message:
<pre>
    hypermail -c /path/to/.hmrc [...]

</pre>
<p>Here's an example of something you might use for "search.php":
<pre>
    &lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
      "http://www.w3.org/TR/html4/strict.dtd">
    &lt;html lang="en">
    &lt;head>
    &lt;title>Search results&lt;/title>
    &lt;/head>
    &lt;body>
    &lt;?
        // Very simple search using swish-e (see http://swish-e.org/)
        // copyright 2003 by Bob Crispen &lt;http://www.crispen.org/>
        // May be distributed without restriction for any purpose.
    
        // This program is distributed in the hope that it will be useful,
        // but WITHOUT ANY WARRANTY; without even the implied warranty of
        // MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
        // GNU General Public License for more details.
    
        // Set these values to the appropriate ones for your system
        $me     = "http://my.host.com/path/search.php";   // URL of this page
        $db_dir = "/path/to/swish-e-databases/";          // Directory where
            // you keep the databases and indexes that swish-e generates
        $swishe = "/usr/local/bin/swish-e";               // swish-e executable
    
        // Get arguments from call
        //  "str" -- String to search for
        //  "db"  -- swish-e Database name (e.g., "site.index")
        $str = $_POST["str"];
        $db  = $_POST["db"];
    
        // This script is probably called from a form similar to the one
        // below.  If you call it without arguments, all it'll do is print
        // the form.
    
        if (($str != "") &amp;&amp; ($db != "")) {
            // Just in case the caller tried any funny business
            $searchfor = escapeshellarg($str);
            $database  = escapeshellarg($db_dir . $db);
    
            // Do the search
            $result = `$swishe -H 0 -d '\t' -w $searchfor -f $database`;
    
            // Turn the results into an array
            $results = split("\n", $result);
    
            // See how many results we have.  Ignore the final blank line.
            $count = count($results)-1;
            if ($count > 0) {
                print("Search results for &lt;b>$searchfor&lt;/b>:\n");
                print("&lt;ul>\n");
                for ($i=0; $i&lt;$count; $i++) {
                    list($score, $url, $title, $len) = split("\t", $results[$i], 4);
                    print("&lt;li> &lt;a href=\"$url\">$title&lt;/a> [$score]\n");
                }
                print("&lt;/ul>\n");
            } else {
                print("Sorry, &lt;b>$searchfor&lt;/b> not found\n");
            }
        }
    
        // Print a new form so they can continue searching
        print("&lt;FORM ACTION=\"$me\" METHOD=\"POST\"
             ENCTYPE=\"application/x-www-form-urlencoded\">\n");
        print("&lt;INPUT TYPE=\"HIDDEN\" NAME=\"db\" VALUE=\"$db\">\n");
        print("&lt;INPUT TYPE=\"TEXT\" NAME=\"str\" SIZE=\"20\">&lt;FONT SIZE=\"2\">\n");
        print("&lt;INPUT TYPE=\"SUBMIT\" VALUE=\"Search\">&lt;/FONT>\n");
        print("&lt;/FORM>\n");
    
    ?>
    &lt;/body>
    &lt;/html>

</pre><p>You might want to add search logging, page control (so you only
print, say, 10 results at a time), some nice CSS, and all sorts of other things to your
script.  All we're illustrating here is basic functionality.
<p>There's no law that says you have to use PHP for the script.  In
fact, since swish-e comes with a very nice Perl interface, you may want
to use that even if your domain host supports PHP.  The swish-e documentation
covers the Perl interface very thoroughly.
<p>Swish-e, like many other search engines, requires you to generate
a search index before you perform any searches.  Here's a .conf file for
swish-e that might generate a reasonable
search index for a hypermail archive of messages about model railroading:
<pre>
    IndexDir /path/to/model-rr-archive
    IndexFile /path/to/model-rr.index
    IndexReport 3
    IndexOnly .html
    ReplaceRules replace "/path/to/document_root/" "http://www.yoursite.com/"
    FileRules filename is attachment.html
    FileRules filename is author.html
    FileRules filename is date.html
    FileRules filename is index.html
    FileRules filename is subject.html
    FileRules filename is thread.html

</pre><p>This tells swish-e to collect data from all the HTML files in your
model railroading archive <i>except</i> the index pages that hypermail generates.
That way, all the search results will point directly to the messages themselves.
<p>When you want to build your search index, you'll call swish-e something like this:
<pre>
    swish-e -v 3 -c /path/to/model-rr.conf &gt; /path/to/model-rr.report 2&gt;&amp;1

</pre>Many people do this either in a cron job during off-peak hours or
through a CGI script that they call whenever they update their archive.
</div>
-- 
<br><i>Bob Crispen</i>
<br><i>Wednesday, April 9, 2003 7:06 PM CDT</i>
<br><br>
</body>
</html>
