#
# Makefile for Hypermail
#
@SET_MAKE@

prefix=@prefix@
exec_prefix=@exec_prefix@
 
# This is where you want hypermail to be installed
bindir=@bindir@
 
# This is where the man page goes
mandir=@mandir@

# This is where your CGI programs live
cgidir=@cgidir@

# Executable program suffix (.exe for windows, null for Unix systems)
SUFFIX=@suffix@

# Compiler to use
CC=@CC@

# Installation program to use
INSTALL_PROG=@INSTALL@ 
 
#WNOERROR=-Werror
#WARNINGS=$(WNOERROR) -ansi -pedantic -Wall -Wtraditional -Wshadow -Wpointer-arith -Wcast-qual -Wcast-align -Waggregate-return -Wstrict-prototypes -Wmissing-prototypes -Wnested-externs -Winline -Dlint

CFLAGS=@CFLAGS@ @INCLUDES@ $(WARNINGS)
YACC=@YACC@
NETLIBS=@LIBS@
LDFLAGS=@LDFLAGS@
OPT_LIBS=@EXTRA_LIBS@

INCS=		domains.h hypermail.h lang.h proto.h \
		../config.h ../patchlevel.h dsprintf.h threadprint.h \
		getdate.h getname.h finelink.h txt2html.h search.h

SRCS=		base64.c date.c domains.c file.c hypermail.c lang.c lock.c \
		mem.c parse.c print.c printfile.c string.c struct.c uudecode.c\
		mprintf.c dmatch.c setup.c threadprint.c getdate.c getname.c\
		finelink.c txt2html.c search.c quotes.c

OBJS=		base64.o date.o domains.o file.o hypermail.o lang.o lock.o \
		mem.o parse.o print.o printfile.o string.o struct.o uudecode.o\
		mprintf.o dmatch.o setup.o threadprint.o getdate.o getname.o\
		finelink.o txt2html.o search.o quotes.o

MAILOBJS=	mail.o ../libcgi/libcgi.a

.c.o:
	$(CC) -c $(CFLAGS) $<

all:   hypermail$(SUFFIX) mail$(SUFFIX)

hypermail$(SUFFIX): $(OBJS) 
	$(CC) -o $@ $(CFLAGS) $(LDFLAGS) $(OPT_LIBS) $(OBJS) 
	chmod 0755 $@

mail$(SUFFIX):	$(MAILOBJS)
	$(CC) -o $@ $(CFLAGS) $(MAILOBJS) $(NETLIBS)
	chmod 0755 $@

lang$(SUFFIX): lang.c lang.h
	$(CC) -DLANG_PROG $(CFLAGS) -o $@ lang.c 

../libcgi/libcgi.a:
	@cd ../libcgi; $(MAKE) all CC="$(CC)" CFLAGS="$(CFLAGS)"

getdate.c: getdate.y getdate.h
	@echo "Expect 13 shift/reduce conflicts."
	$(YACC) getdate.y
	@mv -f y.tab.c getdate.c

install: all
	@if [ ! -d $(bindir) ]; then mkdir -p $(bindir); fi
	$(INSTALL_PROG) -s -c -m 0755 hypermail$(SUFFIX) $(bindir)

mail.install:
	@if [ ! -d $(cgidir) ]; then mkdir -p $(cgidir); fi
	$(INSTALL_PROG) -s -c -m 0755 mail$(SUFFIX) $(cgidir)

uninstall:
	rm -f $(bindir)/hypermail$(SUFFIX)
	rm -f $(cgidir)/mail$(SUFFIX)

insight:
	$(MAKE) CC="insight" 

pure:
	$(MAKE) CFLAGS="-g" $(OBJS)  
	purify $(CC) -o hypermail -g $(CFLAGS) $(OBJS) 

quant:
	$(MAKE) CFLAGS="-g" $(OBJS)
	quantify $(CC) -o hypermail -g $(CFLAGS) $(OBJS)

lint:	
	lint $(SRCS) 2>&1 | tee lint.out

lint_mail:	
	lint mail.c 2>&1 | tee lint.out
	@(cd ../libcgi; $(MAKE) lint 2>&1 | tee -a ../lint.out)

clean:
	rm -f hypermail$(SUFFIX) mail$(SUFFIX) lang$(SUFFIX)
	rm -f *.o .pure *qx *qv *.ln core
	rm -f .inslog tca.map lint.out
	rm -f getdate.c
	@cd ../libcgi; $(MAKE) clean

#
# Regenerate this dependency list with gcc -MM *.c:
#

base64.o : base64.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h base64.h 

date.o : date.c hypermail.h ../config.h ../patchlevel.h mprintf.h \
	proto.h lang.h setup.h 

dmatch.o : dmatch.c dmatch.h ../config.h 

domains.o : domains.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h domains.h 

file.o : file.c hypermail.h ../config.h ../patchlevel.h mprintf.h \
	proto.h lang.h setup.h 

getdate.o : getdate.c ../config.h getdate.h 

getname.o : getname.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h getname.h 

hypermail.o : hypermail.c hypermail.h ../config.h ../patchlevel.h \
	defaults.h mprintf.h proto.h lang.h setup.h parse.h print.h 

lang.o : lang.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h 

lock.o : lock.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h setup.h 

mail.o : mail.c mail.h ../libcgi/cgi.h ../config.h 

mem.o : mem.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h 

mprintf.o : mprintf.c mprintf.h 

parse.o : parse.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h setup.h struct.h uudecode.h base64.h \
	getname.h parse.h 

print.o : print.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h setup.h struct.h printfile.h print.h \
	threadprint.h 

printfile.o : printfile.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h setup.h print.h printfile.h 

setup.o : setup.c hypermail.h ../config.h ../patchlevel.h defaults.h \
	mprintf.h proto.h lang.h setup.h struct.h 

string.o : string.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h setup.h parse.h 

struct.o : struct.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h dmatch.h setup.h struct.h 

threadprint.o : threadprint.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h setup.h struct.h threadprint.h 

uudecode.o : uudecode.c hypermail.h ../config.h ../patchlevel.h \
	mprintf.h proto.h lang.h uudecode.h 
